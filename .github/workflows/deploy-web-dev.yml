name: Deploy Frontend to Development

on:
  push:
    branches: [ develop ]
    paths:
      - 'frontend-nextjs/**'
      - '.github/workflows/deploy-web-dev.yml'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: develop
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: 'projects/662988072447/locations/global/workloadIdentityPools/github-pool/providers/github-provider-v2'
        service_account: 'github-deployment@painaina-dev.iam.gserviceaccount.com'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Parse environment variables  
      run: |
        # Create temporary env file and parse it
        echo "${{ secrets.ENV_FILE_WEB_DEV }}" > .temp_env
        
        # Parse and set environment variables
        while IFS= read -r line || [[ -n "$line" ]]; do
          # Skip empty lines and comments
          if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          # Check if line contains '='
          if [[ "$line" == *"="* ]]; then
            # Extract key and value
            key="${line%%=*}"
            value="${line#*=}"
            
            # Clean key (remove spaces)
            key=$(echo "$key" | tr -d '[:space:]')
            
            # Set environment variable
            echo "${key}=${value}" >> $GITHUB_ENV
          fi
        done < .temp_env
        
        # Cleanup
        rm .temp_env

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker asia-southeast1-docker.pkg.dev
        # Set Docker daemon timeout
        sudo mkdir -p /etc/docker
        echo '{"max-concurrent-uploads": 1}' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker || true

    - name: Build Docker image
      working-directory: frontend-nextjs
      run: |
        docker build \
          --build-arg NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="${{ env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}" \
          --build-arg NEXT_PUBLIC_CONVEX_URL="${{ env.NEXT_PUBLIC_CONVEX_URL }}" \
          --build-arg NEXT_PUBLIC_API_URL="${{ env.NEXT_PUBLIC_API_URL }}" \
          --build-arg NEXT_PUBLIC_FRONTEND_URL="${{ env.NEXT_PUBLIC_FRONTEND_URL }}" \
          --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="${{ env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}" \
          --build-arg NEXT_PUBLIC_UNSPLASH_ACCESS_KEY="${{ env.NEXT_PUBLIC_UNSPLASH_ACCESS_KEY }}" \
          --build-arg NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN="${{ env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN }}" \
          --build-arg NEXT_PUBLIC_GA_ID="${{ env.NEXT_PUBLIC_GA_ID }}" \
          -t asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-web:dev-${{ github.sha }} .

    - name: Push Docker image with retry
      run: |
        for i in {1..3}; do
          echo "Push attempt $i/3"
          if docker push asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-web:dev-${{ github.sha }}; then
            echo "Push successful on attempt $i"
            break
          else
            echo "Push failed on attempt $i"
            if [ $i -eq 3 ]; then
              echo "All push attempts failed"
              exit 1
            fi
            echo "Retrying in 30 seconds..."
            sleep 30
          fi
        done

    - name: Create env vars file
      run: |
        cat > env-vars.yaml << 'EOF'
        NODE_ENV: "${{ env.NODE_ENV }}"
        NEXT_PUBLIC_ENV: "${{ env.NEXT_PUBLIC_ENV }}"
        NEXT_PUBLIC_API_URL: "${{ env.NEXT_PUBLIC_API_URL }}"
        NEXT_PUBLIC_FRONTEND_URL: "${{ env.NEXT_PUBLIC_FRONTEND_URL }}"
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "${{ env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}"
        NEXT_PUBLIC_CLERK_SIGN_IN_URL: "${{ env.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}"
        NEXT_PUBLIC_CLERK_SIGN_UP_URL: "${{ env.NEXT_PUBLIC_CLERK_SIGN_UP_URL }}"
        NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: "${{ env.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL }}"
        NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: "${{ env.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL }}"
        CLERK_SECRET_KEY: "${{ env.CLERK_SECRET_KEY }}"
        NEXT_PUBLIC_CONVEX_URL: "${{ env.NEXT_PUBLIC_CONVEX_URL }}"
        NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: "${{ env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}"
        NEXT_PUBLIC_UNSPLASH_ACCESS_KEY: "${{ env.NEXT_PUBLIC_UNSPLASH_ACCESS_KEY }}"
        NEXT_PUBLIC_UNSPLASH_SECRET_KEY: "${{ env.NEXT_PUBLIC_UNSPLASH_SECRET_KEY }}"
        NEXT_PUBLIC_APP_ID: "${{ env.NEXT_PUBLIC_APP_ID }}"
        NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN: "${{ env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN }}"
        NEXT_PUBLIC_GA_ID: "${{ env.NEXT_PUBLIC_GA_ID }}"
        EOF

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy painaina-web-development \
          --image asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-web:dev-${{ github.sha }} \
          --platform managed \
          --region asia-southeast1 \
          --allow-unauthenticated \
          --port 3000 \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --timeout=600 \
          --env-vars-file=env-vars.yaml