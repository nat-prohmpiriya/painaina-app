name: Deploy Backend to Development

on:
  push:
    branches: [ develop ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: develop
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: 'projects/662988072447/locations/global/workloadIdentityPools/github-pool/providers/github-provider-v2'
        service_account: 'github-deployment@painaina-dev.iam.gserviceaccount.com'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Parse environment variables
      run: |
        # Create temporary env file and source it
        echo "${{ secrets.ENV_FILE }}" > .temp_env
        
        # Debug: Show first few lines
        echo "=== First 10 lines of ENV_FILE ==="
        head -10 .temp_env
        
        # Parse and set environment variables
        while IFS= read -r line || [[ -n "$line" ]]; do
          # Skip empty lines and comments
          if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          # Check if line contains '='
          if [[ "$line" == *"="* ]]; then
            # Extract key and value
            key="${line%%=*}"
            value="${line#*=}"
            
            # Clean key (remove spaces)
            key=$(echo "$key" | tr -d '[:space:]')
            
            # Set environment variable
            echo "${key}=${value}" >> $GITHUB_ENV
            echo "Set: $key"
          fi
        done < .temp_env
        
        # Cleanup
        rm .temp_env

    - name: Debug environment variables
      run: |
        echo "=== Checking parsed environment variables ==="
        echo "MONGODB_URI exists: ${{ env.MONGODB_URI != '' }}"
        echo "FIREBASE_PROJECT_ID exists: ${{ env.FIREBASE_PROJECT_ID != '' }}"
        echo "Number of lines in ENV_FILE: $(echo "${{ secrets.ENV_FILE }}" | wc -l)"

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker asia-southeast1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-api:dev-${{ github.sha }} .

    - name: Push Docker image
      run: |
        docker push asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-api:dev-${{ github.sha }}

    - name: Create env vars file
      run: |
        cat > env-vars.yaml << 'EOF'
        GIN_MODE: "${{ env.GIN_MODE }}"
        SERVICE_NAME: "${{ env.SERVICE_NAME }}"
        SERVICE_VERSION: "${{ env.SERVICE_VERSION }}"
        ENVIRONMENT: "${{ env.ENVIRONMENT }}"
        MONGODB_URI: "${{ env.MONGODB_URI }}"
        MONGODB_DATABASE: "${{ env.MONGODB_DATABASE }}"
        MONGODB_MAX_POOL_SIZE: "${{ env.MONGODB_MAX_POOL_SIZE }}"
        MONGODB_TIMEOUT: "${{ env.MONGODB_TIMEOUT }}"
        REDIS_URL: "${{ env.REDIS_URL }}"
        CLERK_SECRET_KEY: "${{ env.CLERK_SECRET_KEY }}"
        CLERK_PUBLISHABLE_KEY: "${{ env.CLERK_PUBLISHABLE_KEY }}"
        CLERK_JWT_ISSUER_DOMAIN: "${{ env.CLERK_JWT_ISSUER_DOMAIN }}"
        R2_ACCOUNT_ID: "${{ env.R2_ACCOUNT_ID }}"
        R2_ACCESS_KEY_ID: "${{ env.R2_ACCESS_KEY_ID }}"
        R2_SECRET_ACCESS_KEY: "${{ env.R2_SECRET_ACCESS_KEY }}"
        R2_BUCKET_NAME: "${{ env.R2_BUCKET_NAME }}"
        R2_ENDPOINT: "${{ env.R2_ENDPOINT }}"
        R2_DEV_SUBDOMAIN: "${{ env.R2_DEV_SUBDOMAIN }}"
        GOOGLE_PLACES_API_KEY: "${{ env.GOOGLE_PLACES_API_KEY }}"
        UNSPLASH_ACCESS_KEY: "${{ env.UNSPLASH_ACCESS_KEY }}"
        UNSPLASH_SECRET_KEY: "${{ env.UNSPLASH_SECRET_KEY }}"
        CONVEX_DEPLOYMENT_URL: "${{ env.CONVEX_DEPLOYMENT_URL }}"
        OTEL_ENABLED: "${{ env.OTEL_ENABLED }}"
        OTEL_EXPORTER_TYPE: "${{ env.OTEL_EXPORTER_TYPE }}"
        OTEL_SERVICE_NAME: "${{ env.OTEL_SERVICE_NAME }}"
        OTEL_ZIPKIN_ENDPOINT: "${{ env.OTEL_ZIPKIN_ENDPOINT }}"
        OTEL_GCP_PROJECT_ID: "${{ env.OTEL_GCP_PROJECT_ID }}"
        OTEL_OTLP_ENDPOINT: "${{ env.OTEL_OTLP_ENDPOINT }}"
        OTEL_OTLP_HEADERS: "${{ env.OTEL_OTLP_HEADERS }}"
        CORS_ALLOWED_ORIGINS: "${{ env.CORS_ALLOWED_ORIGINS }}"
        CORS_ALLOWED_METHODS: "${{ env.CORS_ALLOWED_METHODS }}"
        CORS_ALLOWED_HEADERS: "${{ env.CORS_ALLOWED_HEADERS }}"
        REDIS_PREFIX: "${{ env.REDIS_PREFIX }}"
        EOF

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy painaina-api-development \
          --image asia-southeast1-docker.pkg.dev/painaina-dev/painaina-images/painaina-api:dev-${{ github.sha }} \
          --platform managed \
          --region asia-southeast1 \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --timeout=600 \
          --allow-unauthenticated \
          --env-vars-file=env-vars.yaml