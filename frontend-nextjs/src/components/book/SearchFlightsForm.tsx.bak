'use client'

import { AutoComplete, Button, DatePicker, Input, Popover } from "antd"
import { LuMapPin } from "react-icons/lu"
import { PiAirplaneTakeoffLight } from "react-icons/pi";
import { LiaExchangeAltSolid } from "react-icons/lia";
import { useState } from "react";
import { useNotification } from '@/contexts/NotificationContext'
import dayjs from "dayjs";

const { RangePicker } = DatePicker;

function SearchFlightsForm() {
    const [passenger, setPassenger] = useState({
        adult: 1,
        child: 0,
        infant: 0,
    });

    const [seat, setSeat] = useState<'Economy' | 'Premium' | 'Business' | 'First class'>('Economy');
    const [tripType, setTripType] = useState<'oneway' | 'roundtrip' | 'multicity'>('oneway');

    const [origin, setOrigin] = useState('');
    const [destination, setDestination] = useState('');
    const [dates, setDates] = useState<[dayjs.Dayjs | null, dayjs.Dayjs | null] | null>(null);
    const [loading, setLoading] = useState(false);
    const { showSuccess, showError } = useNotification();

    const [originOptions, setOriginOptions] = useState<any[]>([]);
    const [destinationOptions, setDestinationOptions] = useState<any[]>([]);

    const getCityIataCode = (cityName: string): string => {
        // Try to extract IATA code from the city name format "City (CODE)"
        const iataMatch = cityName.match(/\(([A-Z]{3})\)/);
        if (iataMatch) {
            return iataMatch[1];
        }

        // If no code found, return the first 3 characters as fallback
        return cityName.substring(0, 3).toUpperCase();
    };

    const handleSearch = async () => {
        if (!origin || !destination || !dates || !dates[0]) {
            showError('Please fill in all required fields');
            return;
        }

        setLoading(true);
        try {
            const seatClass = seat.toLowerCase().replace(' ', '');
            const mappedSeat = seatClass === 'firstclass' ? 'first' : seatClass as 'economy' | 'premium' | 'business' | 'first';

            // Convert city names to IATA codes
            const originCode = getCityIataCode(origin);
            const destinationCode = getCityIataCode(destination);

            const searchParams = {
                origin: originCode,
                destination: destinationCode,
                departure_date: dates[0].format('YYYY-MM-DD'),
                adults: passenger.adult,
                children: passenger.child > 0 ? passenger.child : undefined,
                infants: passenger.infant > 0 ? passenger.infant : undefined,
                trip_class: mappedSeat,
                return_date: tripType === 'roundtrip' && dates[1] ? dates[1].format('YYYY-MM-DD') : undefined
            };

            console.log('Flight search results:', results);
            showSuccess('Flight search completed!');
        } catch (error) {
            console.error('Flight search error:', error);
            showError('Failed to search flights');
        } finally {
            setLoading(false);
        }
    };

    const swapLocations = () => {
        const temp = origin;
        setOrigin(destination);
        setDestination(temp);

        // Swap options as well
        const tempOptions = originOptions;
        setOriginOptions(destinationOptions);
        setDestinationOptions(tempOptions);
    };

    const handleOriginSearch = async (value: string) => {
        if (value.length >= 2) {
            try {
                    term: value,
                    types: ['city', 'airport']
                });
                if (results && Array.isArray(results)) {
                    const options = results.map((item: any) => ({
                        value: `${item.name} (${item.code})`,
                        label: `${item.name} (${item.code}) - ${item.country_name}`,
                        code: item.code,
                        name: item.name,
                        type: item.type,
                        country_name: item.country_name,
                        coordinates: item.coordinates
                    }));
                    setOriginOptions(options);
                }
            } catch (error) {
                console.error('Error searching origin places:', error);
            }
        }
    };

    const handleDestinationSearch = async (value: string) => {
        if (value.length >= 2) {
            try {
                    term: value,
                    types: ['city', 'airport']
                });
                if (results && Array.isArray(results)) {
                    const options = results.map((item: any) => ({
                        value: `${item.name} (${item.code})`,
                        label: `${item.name} (${item.code}) - ${item.country_name}`,
                        code: item.code,
                        name: item.name,
                        type: item.type,
                        country_name: item.country_name,
                        coordinates: item.coordinates
                    }));
                    setDestinationOptions(options);
                }
            } catch (error) {
                console.error('Error searching destination places:', error);
            }
        }
    };

    const content = (<div>
        <div>
            <div className="flex justify-between items-center mb-3">
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, adult: Math.max(1, passenger.adult - 1) })}>-</Button>
                <div className="flex items-center gap-4">
                    <span className="font-bold">{passenger.adult}</span>
                    <span className="font-bold">Adult</span>
                </div>
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, adult: passenger.adult + 1 })}>+</Button>
            </div>
            <div className="flex justify-between items-center mb-3">
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, child: Math.max(0, passenger.child - 1) })}>-</Button>
                <div className="flex items-center gap-4">
                    <span className="font-bold">{passenger.child}</span>
                    <span className="font-bold">Child</span>
                </div>
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, child: passenger.child + 1 })}>+</Button>
            </div>
            <div className="flex justify-between items-center mb-3">
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, infant: Math.max(0, passenger.infant - 1) })}>-</Button>
                <div className="flex items-center gap-4">
                    <span className="font-bold">{passenger.infant}</span>
                    <span className="font-bold">Infant</span>
                </div>
                <Button shape="circle" onClick={() => setPassenger({ ...passenger, infant: passenger.infant + 1 })}>+</Button>
            </div>
            <div className="grid grid-cols-2 gap-2">
                <Button
                    shape="round"
                    block
                    size="large"
                    className="mb-2"
                    type={seat === 'Economy' ? 'primary' : 'default'}
                    onClick={() => setSeat('Economy')}
                >
                    <span>Economy</span>
                </Button>
                <Button
                    shape="round"
                    block
                    size="large"
                    className="mb-2"
                    type={seat === 'Premium' ? 'primary' : 'default'}
                    onClick={() => setSeat('Premium')}
                >
                    <span>Premium</span>
                </Button>
                <Button
                    shape="round"
                    block
                    size="large"
                    className="mb-2"
                    type={seat === 'Business' ? 'primary' : 'default'}
                    onClick={() => setSeat('Business')}
                >
                    <span>Business</span>
                </Button>
                <Button
                    shape="round"
                    block
                    size="large"
                    className="mb-2"
                    type={seat === 'First class' ? 'primary' : 'default'}
                    onClick={() => setSeat('First class')}
                >
                    <span>First Class</span>
                </Button>
            </div>
        </div>
    </div>)

    return (
        <div>
            <div className='bg-white/90 w-[700px] rounded-2xl shadow-lg p-6 pb-12'>
                <div className="flex gap-2 mb-4">
                    <Button type={tripType === 'oneway' ? 'primary' : 'default'} shape="round">
                        <span className="font-semibold" onClick={() => setTripType('oneway')}>One way</span>
                    </Button>
                    <Button type={tripType === 'roundtrip' ? 'primary' : 'default'} shape="round">
                        <span className="font-semibold" onClick={() => setTripType('roundtrip')}>Round Trip</span>
                    </Button>
                    <Button type={tripType === 'multicity' ? 'primary' : 'default'} shape="round">
                        <span className="font-semibold" onClick={() => setTripType('multicity')}>Multi-City</span>
                    </Button>
                </div>
                <div className="flex gap-2 items-center">
                    <AutoComplete
                        style={{ width: '100%' }}
                        options={originOptions}
                        onSearch={handleOriginSearch}
                        value={origin}
                        onSelect={(value, option) => setOrigin(value)}
                        filterOption={false}
                        data-testid="flight-origin-autocomplete"
                    >
                        <Input
                            placeholder='From (City or Airport)'
                            size="large"
                            style={{ borderRadius: '18px', width: '100%' }}
                            prefix={<PiAirplaneTakeoffLight className="text-xl text-gray-400 mr-2" />}
                            onChange={(e) => setOrigin(e.target.value)}
                        />
                    </AutoComplete>
                    <Button
                        icon={<LiaExchangeAltSolid size={20} className="mt-1 text-gray-400" />}
                        shape="circle"
                        size="large"
                        onClick={swapLocations}
                        data-testid="flight-swap-btn"
                    />
                    <AutoComplete
                        style={{ width: '100%' }}
                        options={destinationOptions}
                        onSearch={handleDestinationSearch}
                        value={destination}
                        onSelect={(value, option) => setDestination(value)}
                        filterOption={false}
                        data-testid="flight-destination-autocomplete"
                    >
                        <Input
                            placeholder='To (City or Airport)'
                            size="large"
                            style={{ borderRadius: '18px', width: '100%' }}
                            prefix={<LuMapPin className="text-xl text-gray-400 mr-2" />}
                            onChange={(e) => setDestination(e.target.value)}
                        />
                    </AutoComplete>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-4 ">
                    <div className="col-span-1 flex gap-2">
                        <RangePicker
                            size="large"
                            style={{ width: '100%', borderRadius: '18px' }}
                            value={dates}
                            onChange={(dates) => setDates(dates)}
                            placeholder={['Departure', 'Return']}
                            disabled={tripType === 'oneway' ? [false, true] : false}
                            allowEmpty={[false, tripType === 'oneway']}
                            data-testid="flight-date-picker"
                        />
                    </div>
                    <div className="col-span-1 flex gap-2">
                        <Popover content={content} trigger="click" placement="bottomRight">
                            <Button shape="round" block size="large">
                                <span className="text-sm font-bold">{passenger.adult + passenger.child + passenger.infant} passenger</span>
                                <span className="">,</span>
                                <span className="text-sm font-bold">{seat}</span>
                            </Button>
                        </Popover>
                    </div>

                </div>
            </div>
            <div className="flex justify-center">
                <Button
                    variant='solid'
                    color="danger"
                    size="large"
                    shape="round"
                    style={{ width: '300px', marginTop: '-20px' }}
                    onClick={handleSearch}
                    loading={loading}
                    data-testid="flight-search-btn"
                >
                    <span className="font-semibold">Search Flights</span>
                </Button>
            </div>
        </div>
    )
}

export default SearchFlightsForm