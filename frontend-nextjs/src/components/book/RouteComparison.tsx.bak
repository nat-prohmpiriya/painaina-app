'use client'

import { useState, useEffect } from 'react'
import { Card, Typography, Spin, Row, Col, Button, Input, Tag, Divider } from 'antd'
import { ArrowRight, Plane, Clock, DollarSign, Plus, X } from 'lucide-react'
import { useNotification } from '@/contexts/NotificationContext'

const { Title, Text } = Typography

interface Route {
  id: string
  origin: string
  destination: string
}

interface RouteData {
  id: string
  route: Route
  cheapestPrice?: number
  directFlight?: any
  currency: string
  loading: boolean
  error?: string
}

export default function RouteComparison() {
  const [routes, setRoutes] = useState<RouteData[]>([
    { id: '1', route: { id: '1', origin: 'BKK', destination: 'HKT' }, currency: 'USD', loading: false },
    { id: '2', route: { id: '2', origin: 'BKK', destination: 'CNX' }, currency: 'USD', loading: false }
  ])
  const [newOrigin, setNewOrigin] = useState('')
  const [newDestination, setNewDestination] = useState('')
  const { showError, showSuccess } = useNotification()

  useEffect(() => {
    routes.forEach(routeData => {
      if (!routeData.cheapestPrice && !routeData.loading) {
        fetchRouteData(routeData.route)
      }
    })
  }, [routes])

  const fetchRouteData = async (route: Route) => {
    setRoutes(prev => prev.map(r =>
      r.id === route.id ? { ...r, loading: true, error: undefined } : r
    ))

    try {
      const [cheapestResult, directResult] = await Promise.all([
          origin: route.origin,
          destination: route.destination,
          currency: 'USD'
        }),
          origin: route.origin,
          destination: route.destination,
          currency: 'USD'
        })
      ])

      let cheapestPrice: number | undefined
      let directFlight: any

      if (cheapestResult.success && cheapestResult.data) {
        const destinations = Object.values(cheapestResult.data)
        if (destinations.length > 0) {
          const flights = Object.values(destinations[0] as any)
          if (flights.length > 0) {
            cheapestPrice = (flights[0] as any).price
          }
        }
      }

      if (directResult.success && directResult.data) {
        const destinations = Object.values(directResult.data)
        if (destinations.length > 0) {
          const flights = Object.values(destinations[0] as any)
          if (flights.length > 0) {
            directFlight = flights[0]
          }
        }
      }

      setRoutes(prev => prev.map(r =>
        r.id === route.id
          ? { ...r, cheapestPrice, directFlight, loading: false }
          : r
      ))

    } catch (error) {
      setRoutes(prev => prev.map(r =>
        r.id === route.id
          ? { ...r, loading: false, error: String(error) }
          : r
      ))
      showError('Failed to load route data', String(error))
    }
  }

  const addRoute = () => {
    if (!newOrigin.trim() || !newDestination.trim()) {
      showError('Please enter both origin and destination')
      return
    }

    const newRoute: RouteData = {
      id: Date.now().toString(),
      route: {
        id: Date.now().toString(),
        origin: newOrigin.toUpperCase(),
        destination: newDestination.toUpperCase()
      },
      currency: 'USD',
      loading: false
    }

    setRoutes(prev => [...prev, newRoute])
    setNewOrigin('')
    setNewDestination('')
    showSuccess('Route added successfully')
  }

  const removeRoute = (routeId: string) => {
    if (routes.length <= 1) {
      showError('At least one route must remain')
      return
    }
    setRoutes(prev => prev.filter(r => r.id !== routeId))
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric'
    })
  }

  const getCheapestRoute = () => {
    const validRoutes = routes.filter(r => r.cheapestPrice !== undefined)
    if (validRoutes.length === 0) return null
    return validRoutes.reduce((min, current) =>
      (current.cheapestPrice! < min.cheapestPrice!) ? current : min
    )
  }

  const cheapestRoute = getCheapestRoute()

  return (
    <div className="w-full">
      <div className="mb-6">
        <Title level={3} className="flex items-center gap-2 mb-2">
          <Plane className="text-purple-500" size={24} />
          Route Comparison
        </Title>
        <Text type="secondary">
          Compare flight prices and options across different routes
        </Text>
      </div>

      {/* Add New Route */}
      <Card className="mb-6" data-testid="add-route-card">
        <div className="flex gap-3 items-end">
          <div className="flex-1">
            <Text strong>Origin</Text>
            <Input
              placeholder="e.g., BKK"
              value={newOrigin}
              onChange={(e) => setNewOrigin(e.target.value)}
              className="mt-1"
              data-testid="origin-input"
            />
          </div>
          <ArrowRight className="text-gray-400 mb-2" size={20} />
          <div className="flex-1">
            <Text strong>Destination</Text>
            <Input
              placeholder="e.g., HKT"
              value={newDestination}
              onChange={(e) => setNewDestination(e.target.value)}
              className="mt-1"
              data-testid="destination-input"
            />
          </div>
          <Button
            type="primary"
            icon={<Plus size={16} />}
            onClick={addRoute}
            data-testid="add-route-btn"
          >
            Add Route
          </Button>
        </div>
      </Card>

      {/* Best Deal Banner */}
      {cheapestRoute && (
        <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
          <div className="flex items-center justify-between">
            <div>
              <Text strong className="text-green-800">
                üèÜ Best Deal: {cheapestRoute.route.origin} ‚Üí {cheapestRoute.route.destination}
              </Text>
              <div className="text-green-600 font-bold text-xl">
                ${cheapestRoute.cheapestPrice} USD
              </div>
            </div>
            <Tag color="gold" className="text-lg px-3 py-1">
              Cheapest
            </Tag>
          </div>
        </div>
      )}

      {/* Routes Grid */}
      <Row gutter={[16, 16]}>
        {routes.map((routeData) => (
          <Col xs={24} lg={12} key={routeData.id}>
            <Card
              className="h-full relative"
              data-testid={`route-card-${routeData.route.origin}-${routeData.route.destination}`}
              extra={
                routes.length > 1 && (
                  <Button
                    type="text"
                    danger
                    size="small"
                    icon={<X size={16} />}
                    onClick={() => removeRoute(routeData.id)}
                    data-testid={`remove-route-${routeData.id}`}
                  />
                )
              }
            >
              {routeData.loading ? (
                <div className="flex justify-center py-8">
                  <Spin size="large" />
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Route Header */}
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Text strong className="text-lg">
                        {routeData.route.origin}
                      </Text>
                      <ArrowRight className="text-blue-500" size={16} />
                      <Text strong className="text-lg">
                        {routeData.route.destination}
                      </Text>
                    </div>
                    {routeData.cheapestPrice === cheapestRoute?.cheapestPrice && (
                      <Tag color="gold">Best Price</Tag>
                    )}
                  </div>

                  <Divider className="my-3" />

                  {/* Price Information */}
                  {routeData.cheapestPrice !== undefined ? (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2">
                        <DollarSign className="text-green-500" size={16} />
                        <Text strong className="text-xl text-green-600">
                          ${routeData.cheapestPrice}
                        </Text>
                        <Text type="secondary">{routeData.currency}</Text>
                      </div>

                      {routeData.directFlight && (
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <Text type="secondary">Airline:</Text>
                            <Text>{routeData.directFlight.airline}</Text>
                          </div>
                          <div className="flex justify-between">
                            <Text type="secondary">Departure:</Text>
                            <Text>{formatDate(routeData.directFlight.departure_at)}</Text>
                          </div>
                          <div className="flex justify-between">
                            <Text type="secondary">Return:</Text>
                            <Text>{formatDate(routeData.directFlight.return_at)}</Text>
                          </div>
                          <div className="flex justify-between">
                            <Text type="secondary">Flight:</Text>
                            <Tag color="green">
                              {routeData.directFlight.airline} {routeData.directFlight.flight_number}
                            </Tag>
                          </div>
                        </div>
                      )}
                    </div>
                  ) : routeData.error ? (
                    <div className="text-center py-4">
                      <Text type="danger">Failed to load price data</Text>
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <Text type="secondary">No price data available</Text>
                    </div>
                  )}

                  <Button
                    type="primary"
                    block
                    disabled={!routeData.cheapestPrice}
                    data-testid={`search-btn-${routeData.route.origin}-${routeData.route.destination}`}
                  >
                    Search Flights
                  </Button>
                </div>
              )}
            </Card>
          </Col>
        ))}
      </Row>
    </div>
  )
}