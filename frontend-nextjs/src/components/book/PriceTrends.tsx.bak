'use client'

import { useState, useEffect } from 'react'
import { Card, Typography, Spin, Row, Col, Tag, Select } from 'antd'
import { TrendingUp, Calendar, DollarSign } from 'lucide-react'
import { useNotification } from '@/contexts/NotificationContext'

const { Title, Text } = Typography
const { Option } = Select

interface PriceTrendsProps {
  origin?: string
  destination?: string
  currency?: string
}

interface MonthlyPrice {
  month: string
  price: number
  airline: string
  departure_at: string
  return_at: string
  transfers: number
}

export default function PriceTrends({ 
  origin = 'BKK', 
  destination = 'HKT',
  currency = 'USD'
}: PriceTrendsProps) {
  const [prices, setPrices] = useState<MonthlyPrice[]>([])
  const [loading, setLoading] = useState(false)
  const [selectedMonth, setSelectedMonth] = useState('2025-01')
  const { showError } = useNotification()

  useEffect(() => {
    fetchMonthlyPrices()
  }, [origin, destination, currency, selectedMonth])

  const fetchMonthlyPrices = async () => {
    setLoading(true)
    try {
        origin,
        destination,
        month: selectedMonth,
        currency
      })

      if (result.success && result.data) {
        const pricesArray = Object.entries(result.data)
          .map(([month, data]: [string, any]) => ({
            month,
            price: data.price,
            airline: data.airline,
            departure_at: data.departure_at,
            return_at: data.return_at,
            transfers: data.transfers
          }))
          .sort((a, b) => a.price - b.price)

        setPrices(pricesArray)
      }
    } catch (error) {
      showError('Failed to load price trends', String(error))
    } finally {
      setLoading(false)
    }
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    })
  }

  const formatMonth = (monthString: string) => {
    const [year, month] = monthString.split('-')
    return new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('en-US', {
      month: 'long',
      year: 'numeric'
    })
  }

  const getLowestPrice = () => {
    if (prices.length === 0) return 0
    return Math.min(...prices.map(p => p.price))
  }

  const getPriceColor = (price: number) => {
    const lowestPrice = getLowestPrice()
    if (price === lowestPrice) return 'green'
    if (price <= lowestPrice * 1.2) return 'orange'
    return 'red'
  }

  const months = [
    '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06',
    '2025-07', '2025-08', '2025-09', '2025-10', '2025-11', '2025-12'
  ]

  return (
    <div className="w-full">
      <div className="mb-6">
        <Title level={3} className="flex items-center gap-2 mb-2">
          <TrendingUp className="text-green-500" size={24} />
          Price Trends: {origin} → {destination}
        </Title>
        <div className="flex items-center gap-4 mb-4">
          <Text type="secondary">Select month to view trends:</Text>
          <Select
            value={selectedMonth}
            onChange={setSelectedMonth}
            style={{ width: 200 }}
            data-testid="month-selector"
          >
            {months.map(month => (
              <Option key={month} value={month}>
                {formatMonth(month)}
              </Option>
            ))}
          </Select>
        </div>
      </div>

      {loading ? (
        <div className="flex justify-center py-8">
          <Spin size="large" />
        </div>
      ) : (
        <>
          {prices.length > 0 && (
            <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
              <div className="flex items-center gap-2 mb-2">
                <DollarSign size={16} className="text-green-600" />
                <Text strong className="text-green-800">
                  Best Price: ${getLowestPrice()} {currency}
                </Text>
              </div>
              <Text type="secondary" className="text-sm">
                Lowest price found across all available months
              </Text>
            </div>
          )}

          <Row gutter={[16, 16]}>
            {prices.map((priceData, index) => (
              <Col xs={24} sm={12} lg={8} key={priceData.month}>
                <Card 
                  className="h-full hover:shadow-md transition-shadow"
                  data-testid={`price-card-${priceData.month}`}
                >
                  <div className="space-y-3">
                    <div className="flex justify-between items-start">
                      <div className="flex items-center gap-2">
                        <Calendar size={16} className="text-blue-500" />
                        <Text strong>{formatMonth(priceData.month)}</Text>
                      </div>
                      <Tag color={getPriceColor(priceData.price)}>
                        ${priceData.price}
                      </Tag>
                    </div>

                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <Text type="secondary">Airline:</Text>
                        <Text>{priceData.airline}</Text>
                      </div>
                      <div className="flex justify-between">
                        <Text type="secondary">Departure:</Text>
                        <Text>{formatDate(priceData.departure_at)}</Text>
                      </div>
                      <div className="flex justify-between">
                        <Text type="secondary">Return:</Text>
                        <Text>{formatDate(priceData.return_at)}</Text>
                      </div>
                      <div className="flex justify-between">
                        <Text type="secondary">Transfers:</Text>
                        <Tag color={priceData.transfers === 0 ? 'green' : 'orange'}>
                          {priceData.transfers === 0 ? 'Direct' : `${priceData.transfers} stops`}
                        </Tag>
                      </div>
                    </div>

                    {priceData.price === getLowestPrice() && (
                      <div className="text-center">
                        <Tag color="gold">Best Deal!</Tag>
                      </div>
                    )}
                  </div>
                </Card>
              </Col>
            ))}
          </Row>
        </>
      )}

      {!loading && prices.length === 0 && (
        <div className="text-center py-8">
          <Text type="secondary">
            No price data available for {origin} → {destination} in {formatMonth(selectedMonth)}
          </Text>
        </div>
      )}
    </div>
  )
}